#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C0413,W0105


"service"


import getpass
import os
import pathlib
import pwd
import sys


sys.path.insert(0, os.getcwd())


from nixt.command import pidname, scanner
from nixt.modules import face
from nixt.runtime import Errors
from nixt.runtime import forever, init, wrap


def errors():
    "print errors."
    for err in Errors.errors:
        for line in err:
            print(line)


def pidfile(filename):
    "write the pid to a file."
    if os.path.exists(filename):
        os.unlink(filename)
    path2 = pathlib.Path(filename)
    path2.parent.mkdir(parents=True, exist_ok=True)
    with open(filename, "w", encoding="utf-8") as fds:
        fds.write(str(os.getpid()))


def privileges(username):
    "privileges."
    pwnam2 = pwd.getpwnam(username)
    os.setgid(pwnam2.pw_gid)
    os.setuid(pwnam2.pw_uid)


def main():
    "main"
    privileges(getpass.getuser())
    pidfile(pidname())
    scanner(face)
    init(face)
    forever()


if __name__ == "__main__":
    wrap(main)
    errors()
