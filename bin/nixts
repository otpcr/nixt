#!/usr/bin/env python3
# This file is placed in the Public Domain.


"service"


import getpass
import os
import pathlib
import pwd


from nixt.command import scan
from nixt.default import Config
from nixt.persist import Workdir, pidname
from nixt.runtime import errors, exceptions, forever, later


from nixt import modules as MODS


cfg     = Config()
cfg.dis = "upt"


Workdir.wdr = os.path.expanduser(f"~/.{Config.name}")


def privileges():
    """ drop privileges. """
    pwnam2 = pwd.getpwnam(getpass.getuser())
    os.setgid(pwnam2.pw_gid)
    os.setuid(pwnam2.pw_uid)


def pidpath(filename):
    """ write the pid to file. """
    if os.path.exists(filename):
        os.unlink(filename)
    path2 = pathlib.Path(filename)
    path2.parent.mkdir(parents=True, exist_ok=True)
    with open(filename, "w", encoding="utf-8") as fds:
        fds.write(str(os.getpid()))


def service():
    """ run as service. """
    privileges()
    pidpath(pidname(Config.name))
    scan(MODS, init=True)
    forever()


def wrap(func):
    """ wrapper functione. """
    try:
        func()
    except (KeyboardInterrupt, EOFError):
        print("")
    except exceptions as ex:
        later(ex)
    for line in errors():
        print(line)


def main():
    """ wrap service. """
    wrap(service)


if __name__ == "__main__":
    main()
