#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=R,W0105,C0413,W0611


"cli"


import getpass
import inspect
import os
import pathlib
import pwd
import sys
import time
import threading
import _thread


sys.path.insert(0, os.getcwd())


from nixt.command import Commands, command, scanner
from nixt.main    import Client, Config, modnames, parse, scanner
from nixt.modules import face
from nixt.object  import Obj, keys
from nixt.runtime import Broker, Event, Reactor, later, launch


NAME      = __file__.rsplit("/", maxsplit=1)[-1]
STARTTIME = time.time()
TXT = """[Unit]
Description=%s
After=network-online.target

[Service]
Type=simple
User=%s
Group=%s
ExecStart=/home/%s/.local/bin/%ss

[Install]
WantedBy=multi-user.target"""


cfg = Config()


class CLI(Client):

    "CLI"

    def raw(self, txt):
        "print text."
        print(txt)


def cmd(event):
    "list commands."
    event.reply(",".join(sorted(keys(Commands.cmds))))


def srv(event):
    "create service file (pipx)."
    name  = getpass.getuser()
    event.reply(TXT % (NAME.upper(), name, name, name, NAME))


def main():
    "main"
    Commands.add(cmd)
    Commands.add(srv)
    parse(cfg, " ".join(sys.argv[1:]))
    scanner(face)
    cli = CLI()
    evt = Event()
    evt.orig = repr(cli)
    evt.txt = cfg.txt
    evt.type = "event"
    command(cli, evt)
    evt.wait()


if __name__ == "__main__":
    main()
